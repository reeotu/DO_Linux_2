## Part 1. Инструмент **ipcalc**

#### 1.1. Сети и маски

##### Определи и запиши в отчёт:

##### 1) Адрес сети *192.167.38.54/13*

![Выполнение команды ipcalc](./screen/screen1.png)

##### 2) Перевод маски *255.255.255.0* в префиксную и двоичную запись

##### Префиксная каждый 255 = 11111111 (8 бит), 0 = 00000000 (0 бит) = 8+8+8+0 = 24

![Выполнение команды ipcalc](./screen/screen2.png)

##### Двоичная 11111111.11111111.11111111.00000000

![Выполнение команды ipcalc](./screen/screen2.png)

##### */15* в обычную и двоичную

##### Обыная

![Выполнение команды ipcalc](./screen/screen3.png)

##### Двоичная

![Выполнение команды ipcalc](./screen/screen3.png)

##### *11111111.11111111.11111111.11110000* в обычную

##### Для того чтоб в ipcalc рачитать двоичную маску, нужно ее перевести вручную. Посчитать каждый октет. Если все биты в октете = 1 в целом вес октета будет 255. В последнем октете идет *11110000*. Расчитаем именно это так: 1(128) + 1(64) + 1(32) + 1 (16) + 0 + 0 + 0 + 0 = 240.

![Выполнение команды ipcalc](./screen/screen4.png)


##### Префиксную

##### Для того, чтоб расчитать префиксную мы складываем каждый бит в октете, так и выходит, что 8+8+8+4 = 28

![Выполнение команды ipcalc](./screen/screen5.png)

##### 3) Минимальный и максимальный хост в сети *12.167.38.4* при масках: */8*, *11111111.11111111.00000000.00000000*, *255.255.254.0* и */4*

##### Маска */8*:

##### Hostmin - 12.0.0.1
##### Hostmax - 12.255.255.254

![Выполнение команды ipcalc](./screen/screen6.png)

##### Маска *11111111.11111111.00000000.00000000*:

##### Hostmin - 12.167.0.1
##### Hostmax - 12.167.255.254

![Выполнение команды ipcalc](./screen/screen11.png)

##### Маска *255.255.254.0*:

##### Hostmin - 12.167.38.1
##### Hostmax - 12.167.39.254

![Выполнение команды ipcalc](./screen/screen10.png)

##### Маска */4*:

##### Hostmin - 0.0.0.1
##### Hostmax - 15.255.255.254

![Выполнение команды ipcalc](./screen/screen9.png)

#### 1.2. localhost
##### Определи и запиши в отчёт, можно ли обратиться к приложению, работающему на localhost, со следующими IP: *194.34.23.100*, *127.0.0.2*, *127.1.0.1*, *128.0.0.1*

##### Адреса к которым можно обратиться: *127.0.0.2*, *127.1.0.1* (есть пометка Loopback)

![Выполнение команды ipcalc](./screen/screen12.png)

##### Адреса к которым нельзя обратиться: *194.34.23.100*, *128.0.0.1* (нет пометки Loopback)

![Выполнение команды ipcalc](./screen/screen13.png)

#### 1.3. Диапазоны и сегменты сетей
##### Определи и запиши в отчёт:
##### 1) Какие из перечисленных IP можно использовать в качестве публичного, а какие только в качестве частных: *10.0.0.45*, *134.43.0.2*, *192.168.4.2*, *172.20.250.4*, *172.0.2.1*, *192.172.0.1*, *172.68.0.2*, *172.16.255.255*, *10.10.10.10*, *192.169.168.1*

##### Нельзя использовать в качестве публичных: *10.0.0.45*, *192.168.4.2*, *172.20.250.4*, *172.16.255.255*, *10.10.10.10*

![Выполнение команды ipcalc](./screen/screen14.png)

![Выполнение команды ipcalc](./screen/screen15.png)

##### Можно использовать в качестве публичных: *134.43.0.2*, *172.0.2.1*, *192.172.0.1*, *172.68.0.2*, *192.169.168.1*

![Выполнение команды ipcalc](./screen/screen16.png)

![Выполнение команды ipcalc](./screen/screen17.png)

##### *Пояснение*: В IP-адресах которые нельзя использовать в качестве публичных в утилите есть надпись "Private Internet". Соответсвенно если нет такой надписи, то такие IP-адреса можно использовать в качестве публичных.

##### 2) Какие из перечисленных IP-адресов шлюза возможны у сети *10.10.0.0/18*: *10.0.0.1*, *10.10.0.2*, *10.10.10.10*, *10.10.100.1*, *10.10.1.255*

##### Пояснение для утилиты ipcalc. Для того чтоб узнать возможные шлюзы мы к каждому ip-адресу применяем маску */18*, если Network совпадает у обеих адресов - значит он может быть шлюзом.

![Выполнение команды ipcalc](./screen/screen19.png)

##### Возожные шлюзы: *10.10.0.2*, *10.10.10.10*, *10.10.1.255*

## Part 2. Статическая маршрутизация между двумя машинами

##### Подними две виртуальные машины (далее -- ws1 и ws2).

##### С помощью команды `ip a` посмотри существующие сетевые интерфейсы.

##### WS1:

![part2](./screen/screen20.png)

##### WS2:

![part2](./screen/screen21.png)

##### Опиши сетевой интерфейс, соответствующий внутренней сети, на обеих машинах и задай следующие адреса и маски: ws1 — *192.168.100.10*, маска */16*, ws2 — *172.24.116.8*, маска */12*.

##### WS1:

![part2](./screen/screen22.png)

##### WS2:

![part2](./screen/screen23.png)

##### Выполни команду `netplan apply` для перезапуска сервиса сети.

##### WS1:

![part2](./screen/screen24.png)

##### WS2:

![part2](./screen/screen25.png)

#### 2.1. Добавление статического маршрута вручную
##### Добавь статический маршрут от одной машины до другой и обратно при помощи команды вида `ip r add`.
##### Пропингуй соединение между машинами.

##### WS1:

![part2](./screen/screen26.png)

##### WS2:

![part2](./screen/screen27.png)

#### 2.2. Добавление статического маршрута с сохранением
##### Перезапусти машины.
##### Добавь статический маршрут от одной машины до другой с помощью файла */etc/netplan/00-installer-config.yaml*.

##### WS1:

![part2](./screen/screen28.png)

![part2](./screen/screen30.png)

##### WS2:

![part2](./screen/screen29.png)

![part2](./screen/screen31.png)

## Part 3. Утилита **iperf3**

#### 3.1. Скорость соединения
##### Переведи и запиши в отчёт: 8 Mbps в MB/s, 100 MB/s в Kbps, 1 Gbps в Mbps.

##### 8 Mbps = 1 MB/s
##### 100 MB/s = 800 000 Kbps
##### 1 Gbps = 1000 Mbps

#### 3.2. Утилита **iperf3**
##### Измерь скорость соединения между ws1 и ws2.

##### WS1:

![part3](./screen/screen32.png)

##### WS2:

![part3](./screen/screen33.png)

## Part 4. Сетевой экран

#### 4.1. Утилита **iptables**
##### Создай файл */etc/firewall.sh*, имитирующий файрвол, на ws1 и ws2:
```shell
#!/bin/sh

# Удаление всех правил в таблице «filter» (по умолчанию).
iptables -F
iptables -X
```
##### Нужно добавить в файл подряд следующие правила:
##### 1) На ws1 примени стратегию, когда в начале пишется запрещающее правило, а в конце пишется разрешающее правило (это касается пунктов 4 и 5).
##### 2) На ws2 примени стратегию, когда в начале пишется разрешающее правило, а в конце пишется запрещающее правило (это касается пунктов 4 и 5).
##### 3) Открой на машинах доступ для порта 22 (ssh) и порта 80 (http).
##### 4) Запрети *echo reply* (машина не должна «пинговаться», т. е. должна быть блокировка на OUTPUT).
##### 5) Разреши *echo reply* (машина должна «пинговаться»).

##### WS1:

![par4](./screen/screen34.png)

##### WS2:

![part4](./screen/screen35.png)

##### Запусти файлы на обеих машинах командами `chmod +x /etc/firewall.sh` и `/etc/firewall.sh`.

##### WS1:

![part4](./screen/screen36.png)

##### WS2:

![part4](./screen/screen37.png)

##### *Разница между стратегиями, применёнными в первом и втором файлах, заключается в следующем: в утилите iptables правила выполняются сверху вниз. На первой машине первым указано запрещающее правило на выход, поэтому она не сможет пропинговать другую машину. У второй машины, наоброт - первым указано разрешающее правило, значит она сможет пропинговать другую машину.*

#### 4.2. Утилита **nmap**
##### Командой **ping** найди машину, которая не «пингуется», после чего утилитой **nmap** покажи, что хост машины запущен.

##### WS1:

![part4](./screen/screen38.png)


![part4](./screen/screen40.png)

##### WS2:

![part4](./screen/screen39.png)

##### Сохрани дампы образов виртуальных машин

##### Для сохранения образов машины в настройках машины выбираем snapshots.

![part4](./screen/screen41.png)

##### Затем take и добавляем snapshots.

![part4](./screen/screen41.png)

##### ГОТОВО!! Дампы образов сохранены!

## Part 5. Статическая маршрутизация сети

##### Подними пять виртуальных машин (3 рабочие станции (ws11, ws21, ws22) и 2 роутера (r1, r2)).

#### 5.1. Настройка адресов машин
##### Настрой конфигурации машин в *etc/netplan/00-installer-config.yaml* согласно сети на рисунке.

##### R1:

![part5](./screen/screen43.png)

##### R2:

![part5](./screen/screen44.png)

##### WS11:

![part5](./screen/screen45.png)

##### WS21:

![part5](./screen/screen46.png)

##### WS22:

![part5](./screen/screen47.png)

##### Перезапусти сервис сети. Если ошибок нет, командой `ip -4 a` проверь, что адрес машины задан верно. Также пропингуй ws22 с ws21. Аналогично пропингуй r1 с ws11.

##### R1:

![part5](./screen/screen48.png)

##### R2:

![part5](./screen/screen49.png)

##### WS11:

![part5](./screen/screen50.png)

##### WS21:

![part5](./screen/screen51.png)

##### WS22:

![part5](./screen/screen52.png)

##### Также пропингуй ws22 с ws21. Аналогично пропингуй r1 с ws11.

##### ws22 с ws21:

![part5](./screen/screen53.png)

##### r1 c ws11:

![part5](./screen/screen54.png)

#### 5.2. Включение переадресации IP-адресов
##### Для включения переадресации IP выполни команду на роутерах:

##### R1:

![part5](./screen/screen55.png)

##### R2:

![part5](./screen/screen56.png)

##### Открой файл */etc/sysctl.conf* и добавь в него следующую строку:
`net.ipv4.ip_forward = 1`

##### R1:

![part5](./screen/screen57.png)

##### R2:

![part5](./screen/screen58.png)

#### 5.3. Установка маршрута по умолчани

##### Настрой маршрут по умолчанию (шлюз) для рабочих станций. Для этого добавь `default` перед IP-роутера в файле конфигураций.

##### WS11:

![part5](./screen/screen59.png)

##### WS21:

![part5](./screen/screen60.png)

##### WS22:

![part5](./screen/screen61.png)

##### Вызови `ip r` и покажи, что добавился маршрут в таблицу маршрутизации.

##### WS11:

![part5](./screen/screen62.png)

##### WS21:

![part5](./screen/screen63.png)

##### WS22:

![part5](./screen/screen64.png)

##### Пропингуй с ws11 роутер r2 и покажи на r2, что пинг доходит. Для этого используй команду:
`tcpdump -tn -i eth0`

##### На r2 сначла прописываем tcpdump -tn -i enp0s8:

![part5](./screen/screen65.png)

##### Затем на ws11 пингуем и и тем самым видим что пинг проходит:

![part5](./screen/screen66.png)

#### 5.4. Добавление статических маршрутов
##### Добавь в роутеры r1 и r2 статические маршруты в файле конфигураций. Пример для r1 маршрута в сетку 10.20.0.0/26:
```shell
# Добавь в конец описания сетевого интерфейса eth1:
- to: 10.20.0.0
  via: 10.100.0.12
```

##### r1:

![part5](./screen/screen67.png)

##### r2:

![part5](./screen/screen68.png)

##### Вызови `ip r` и покажи таблицы с маршрутами на обоих роутерах.

##### r1:

![part5](./screen/screen69.png)

##### r2:

![part5](./screen/screen70.png)

##### Запусти команды на ws11:

![part5](./screen/screen71.png)

##### *Для адреса 10.10.0.0/18 был выбран маршрут, другой от 0.0.0.0/0. Машина ws11 соединена с сетью 10.10.0.0/18 по своему IP-адресу 10.10.0.2, для других адресов используется маршрут по умолчанию, который указан в файле 10.10.0.1.*

#### 5.5. Построение списка маршрутизаторов

##### Запусти на r1 команду дампа:
`tcpdump -tnv -i eth0`
##### При помощи утилиты **traceroute** построй список маршрутизаторов на пути от ws11 до ws21.

##### r1:

![part5](./screen/screen72.png)

##### ws11:

![part5](./screen/screen73.png)

##### *Каждый пакет проходит на своем пути определенное количество узлов, пока достигнет своей цели. Причем, каждый пакет имеет свое время жизни. Это количество узлов, которые может пройти пакет перед тем, как он будет уничтожен. Этот параметр записывается в заголовке TTL, каждый маршрутизатор, через который будет проходить пакет уменьшает его на единицу. При TTL=0 пакет уничтожается, а отправителю отсылается сообщение Time Exceeded.*

##### *Команда traceroute linux использует UDP пакеты. Она отправляет пакет с TTL=1 и смотрит адрес ответившего узла, дальше TTL=2, TTL=3 и так пока не достигнет цели. Каждый раз отправляется по три пакета и для каждого из них измеряется время прохождения. Пакет отправляется на случайный порт, который, скорее всего, не занят. Когда утилита traceroute получает сообщение от целевого узла о том, что порт недоступен трассировка считается завершенной.*

#### 5.6. Использование протокола **ICMP** при маршрутизации
##### Запусти на r1 перехват сетевого трафика, проходящего через eth0 с помощью команды:
`tcpdump -n -i eth0 icmp`
##### Пропингуй с ws11 несуществующий IP (например, *10.30.0.111*) с помощью команды:
`ping -c 1 10.30.0.111`

##### r1:

![part5](./screen/screen75.png)

##### ws11:

![part5](./screen/screen74.png)

##### ДАМПЫ СОХРАНЕНЫ!!!!

## Part 6. Динамическая настройка IP с помощью **DHCP**

##### Для r2 настрой в файле */etc/dhcp/dhcpd.conf* конфигурацию службы **DHCP**:
##### 1) Укажи адрес маршрутизатора по умолчанию, DNS-сервер и адрес внутренней сети. Пример файла для r2:
```shell
subnet 10.100.0.0 netmask 255.255.0.0 {}

subnet 10.20.0.0 netmask 255.255.255.192
{
    range 10.20.0.2 10.20.0.50;
    option routers 10.20.0.1;
    option domain-name-servers 10.20.0.1;
}
```

![part6](./screen/screen76.png)

##### 2) В файле *resolv.conf* пропиши `nameserver 8.8.8.8`.

![part6](./screen/screen77.png)

##### Перезагрузи службу **DHCP** командой `systemctl restart isc-dhcp-server`. Машину ws21 перезагрузи при помощи `reboot` и через `ip a` покажи, что она получила адрес. Также пропингуй ws22 с ws21.

##### Перезапуск службы DHCP:

![part6](./screen/screen78.png)

##### Машину ws21 перезагрузи при помощи `reboot` и через `ip a` покажи, что она получила адрес:

![part6](./screen/screen79.png)

##### Пропингуй ws22 с ws21:

![part6](./screen/screen80.png)

##### Укажи MAC-адрес у ws11, для этого в *etc/netplan/00-installer-config.yaml* надо добавить строки: `macaddress: 10:10:10:10:10:BA`, `dhcp4: true`.

![part6](./screen/screen82.png)

##### Для r1 настрой аналогично r2, но сделай выдачу адресов с жесткой привязкой к MAC-адресу (ws11). Проведи аналогичные тесты.

![part6](./screen/screen83.png)

![part6](./screen/screen84.png)

##### Проведи аналогичные тесты.

![part6](./screen/screen85.png)

##### Запроси с ws21 обновление IP-адреса.

##### Запросим с ws21 обновление ip адреса с помощью команды sudo dhclient -v, затем ip a.

![part6](./screen/screen86.png)

##### Выполним команду для удаления старого IP адреса sudo dhclient -r

![part6](./screen/screen87.png)

##### Чтобы обновить или освободить IP-адрес для конкретного интерфейса, необходимо ввести: dhclient -r enp0s8, dhclient enp0s8



*В части 6 были использованы следующие опции DHCP протокола:

option routers ip-address [, ip-address...]; - адреса шлюзов для клиентской сети.Маршрутизаторы должны быть перечислены в порядке предпочтительности.
option domain-name-servers ip-address [, ip-address...]; - Список DNS серверов доступных клиенту. Сервера должны быть перечислены в порядке предпочтительности.*

##### ДАМПЫ СОХРАНЕНЫ !!

## Part 7. **NAT**

##### В файле */etc/apache2/ports.conf* на ws22 и r1 измени строку `Listen 80` на `Listen 0.0.0.0:80`, то есть сделай сервер Apache2 общедоступным.

##### ws22:

![part7](./screen/screen88.png)

##### r1:

![part7](./screen/screen89.png)

##### Запусти веб-сервер Apache командой `service apache2 start` на ws22 и r1.

![part7](./screen/screen90.png)

![part7](./screen/screen91.png)

##### Добавь в фаервол, созданный по аналогии с фаерволом из Части 4, на r2 следующие правила:
##### 1) Удаление правил в таблице filter — `iptables -F`;
##### 2) Удаление правил в таблице «NAT» — `iptables -F -t nat`;
##### 3) Отбрасывать все маршрутизируемые пакеты — `iptables --policy FORWARD DROP`.
##### Запусти файл также, как в Части 4.
##### Проверь соединение между ws22 и r1 командой `ping`.

![part7](./screen/screen92.png)

![part7](./screen/screen93.png)

![part7](./screen/screen94.png)

##### Добавь в файл ещё одно правило:
##### 4) Разрешить маршрутизацию всех пакетов протокола **ICMP**.
##### Запусти файл также, как в Части 4.
##### Проверь соединение между ws22 и r1 командой `ping`.

![part7](./screen/screen95.png)

![part7](./screen/screen96.png)

##### Добавь в файл ещё два правила:
##### 5) Включи **SNAT**, а именно маскирование всех локальных IPиз локальной сети, находящейся за r2 (по обозначениям из Части 5 — сеть 10.20.0.0).
##### 6) Включи **DNAT** на 8080 порт машины r2 и добавить к веб-серверу Apache, запущенному на ws22, доступ извне сети.

![part7](./screen/screen97.png)

##### Запусти файл также, как в Части 4.

![part7](./screen/screen98.png)

##### Проверь соединение по TCP для **SNAT**: для этого с ws22 подключиться к серверу Apache на r1 командой:
`telnet [адрес] [порт]`

![part7](./screen/screen99.png)

##### Проверь соединение по TCP для **DNAT**: для этого с r1 подключиться к серверу Apache на ws22 командой `telnet` (обращаться по адресу r2 и порту 8080).

![part7](./screen/screen100.png)

##### ДАМПЫ СОХРАНИЛ!
